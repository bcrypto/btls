\begin{appendix}{В}{обязательное}
{Криптонаборы семейства BIGN\_WITH\_BELT}
\label{BSUITES}

\mbox{}

В настоящем приложении определяются криптонаборы и методы аутентификации 
сторон протокола TLS, основанные на криптографических алгоритмах 
СТБ~34.101.31 и СТБ~34.101.45.  

\hiddensection{Криптонаборы}\label{BSUITES.1}

Определяемые криптонаборы перечислены в таблице~\ref{Table.BSUITES.1}.

\mbox{}

\begin{table}[!h]
\caption{Криптонаборы семейства BIGN\_WITH\_BELT}\label{Table.BSUITES.1}
\begin{tabular}{|l|l|l|}
\hline
Криптонабор &  Иденти-       &  Алгоритм \\
            &  фикатор       &  формирования\\
            &                &  общего ключа\\
\hline
{\small TLS\_DHE\_BIGN\_WITH\_BELT\_CTR\_MAC\_HBELT} &	
\{192, 21\} &	
{\small DHE\_BIGN}\\
%
{\small TLS\_DHE\_BIGN\_WITH\_BELT\_DWP\_HBELT} & 
\{192, 22\} & 
{\small DHE\_BIGN}\\
\hline
%
{\small TLS\_DHT\_BIGN\_WITH\_BELT\_CTR\_MAC\_HBELT} &
\{192, 23\} &
{\small DHT\_BIGN}\\
%
{\small TLS\_DHT\_BIGN\_WITH\_BELT\_DWP\_HBELT} & 
\{192, 24\} &
{\small DHT\_BIGN}\\
\hline
%
{\small TLS\_DHE\_PSK\_BIGN\_WITH\_BELT\_CTR\_MAC\_HBELT} &	
\{192, 25\} & 
{\small DHE\_PSK\_BIGN}\\
%
{\small TLS\_DHE\_PSK\_BIGN\_WITH\_BELT\_DWP\_HBELT} & 
\{192, 26\} & 
{\small DHE\_PSK\_BIGN}\\
\hline
{\small TLS\_DHT\_PSK\_BIGN\_WITH\_BELT\_CTR\_MAC\_HBELT} & 
\{192, 27\} & 
{\small DHT\_PSK\_BIGN}\\
%
{\small TLS\_DHT\_PSK\_BIGN\_WITH\_BELT\_DWP\_HBELT} &
\{192, 28\} &
{\small DHT\_PSK\_BIGN}\\
\hline
\end{tabular}
\end{table}

Криптонабор TLS\_DHE\_BIGN\_WITH\_BELT\_CTR\_MAC\_HBELT является 
обязательным в семействе BIGN\_WITH\_BELT. 

Во всех криптонаборах используется один и тот же алгоритм генерации
псевдослучайных чисел (см.~\ref{BSUITES.2.2}). Отличаются алгоритмы шифрования
и имитозащиты (см.~\ref{BSUITES.2.1}), 
алгоритмы формирования общего ключа (см.~\ref{BSUITES.2.3}). 

\hiddensection{Алгоритмы криптонаборов}\label{BSUITES.2}

\subsection{Алгоритмы шифрования и имитозащиты}\label{BSUITES.2.1}

\subsubsection{Шифрование в режиме счетчика}\label{BSUITES.2.1.1}

Если в название криптонабора входит строка \_CTR, то должен использоваться 
алгоритм шифрования в режиме счетчика, определенный в СТБ~34.101.31 
(пункт~6.5). Этот алгоритм включается в перечисление 
\lstinline{BulkCipherAlgorithm} под именем \lstinline{belt_ctr}: 
\begin{lstlisting}
BulkCipherAlgorithm += {belt_ctr};
\end{lstlisting}

Алгоритм классифицируется как алгоритм поточного шифрования (\lstinline{stream}) 
и действуют правила, заданные в~\ref{RECORD.3.3.1}.  

Ключ шифрования (\lstinline{client_write_key} или
\lstinline{server_write_key}) вырабатывается в процессе выполнения
протокола Handshake. Длина ключа
(\mbox{\lstinline{SecurityParameters.enc_key_length}}) ДОЛЖНА равняться 32.

В качестве синхропосылки ДОЛЖЕН использоваться порядковый номер
\lstinline{seq_num}, определенный в~\ref{RECORD.2},~\ref{RECORD.3.3.1}.
Порядковый номер состоит из 8 байтов. Для получения синхропосылки данный
номер ДОЛЖЕН быть дополнен 8 нулевыми байтами.

\subsubsection{Имитозащита}\label{BSUITES.2.1.2}

Если в название криптонабора входит строка \_MAC, то должен использоваться
алгоритм выработки имитовставки, определенный в СТБ~34.101.31 (пункт~6.6).
Этот алгоритм включается в перечисление \lstinline{MACAlgorithm} под 
именем~\lstinline{belt_mac}:
\begin{lstlisting}
MACAlgorithm += {belt_mac};
\end{lstlisting}

Ключ имитозащиты вырабатывается в процессе выполнения протокола
Handshake. Длина ключа
(\lstinline{SecurityParameters.mac_key_length}) ДОЛЖНА равняться 32.

Имитовставка добавляется к открытым данным перед их зашифрованием
(см.~\ref{RECORD.3.3.1},~\ref{RECORD.3.3.2}). Длина имитовставки
(\lstinline{SecurityParameters.mac_lenght}) равняется 8.

\subsubsection{Одновременное шифрование и имитозащита}\label{BSUITES.2.1.3}

Если в название криптонабора входит строка \_DWP, то должны использоваться 
алгоритмы одновременного шифрования и имитозащиты данных, определенные в 
СТБ~34.101.31 (пункт~6.7). Эти алгоритмы включаются в перечисление 
\lstinline{BulkCipherAlgorithm} под именем~\lstinline{belt_dwp}: 
\begin{lstlisting}
BulkCipherAlgorithm += {belt_dwp};
\end{lstlisting}

Алгоритмы классифицируются как \lstinline{aead} и действуют правила, 
заданные в~\ref{RECORD.3.3.3}. 

Ключ защиты (\lstinline{client_write_key} или 
\lstinline{server_write_key}) вырабатывается в процессе выполнения 
протокола Handshake. Длина ключа (\lstinline{enc_key_length})  
ДОЛЖНА равняться 32. 

Неявная часть синхропосылки (\lstinline{client_write_IV} 
или~\lstinline{server_write_IV}) 
вырабатывается в процессе выполнения протокола~Handshake. Длина неявной  
части (\lstinline{SecurityParameters.fixed_iv_length}) равняется 8. 
Явная часть синхропосылки передается вместе с данными в поле 
\mbox{\lstinline{GenericAEADCipher.nonce_explicit}.} 
%
Длина явной части (\lstinline{SecurityParameters.record_iv_length}) 
также равняется 8. В рамках одного соединения все явные части синхропосылок 
ДОЛЖНЫ различаться. Явная часть МОЖЕТ совпадать с порядковым номером 
\lstinline{seq_num}, определенном в~\ref{RECORD.2},~\ref{RECORD.3.3.3}.  
%
Общая синхропосылка определяется как объединение 
\mbox{\lstinline{client_write_IV + GenericAEADCipher.nonce_explicit}} 
(для данных, отправляемых клиентом) или 
\mbox{\lstinline{server_write_IV + GenericAEADCipher.nonce_explicit}} 
(для данных, отправляемых сервером).  

\subsection{Алгоритм генерации псевдослучайных чисел}\label{BSUITES.2.2}

Для генерации псевдослучайных чисел ДОЛЖЕН использоваться алгоритм, 
определенный в~\ref{CRYPTO.2.3}. При построении алгоритма генерации псевдослучайных 
чисел ДОЛЖЕН использоваться алгоритм хэширования, определенный в СТБ~34.101.31 
(пункт~6.9). Названия криптонаборов снабжены суффиксом \_HBELT, 
который указывает на выбор данного алгоритма хэширования. 

\subsection{Алгоритмы формирования общего ключа}\label{BSUITES.2.3}

Для формирования общего ключа используются алгоритмы, перечисленные в 
таблице~\ref{Table.BSUITES.2}. 

\begin{table}[!h]
\caption{Алгоритмы формирования общего ключа криптонаборов BIGN\_WITH\_BELT}
\label{Table.BSUITES.2}
\begin{tabular}{|l|p{11.3cm}|}
\hline
Алгоритм формирования & Описание \\
общего ключа &\\
\hline
DHE\_BIGN &  Протокол Диффи~-- Хеллмана с эфемерными ключами и 
базовыми операциями СТБ~34.101.45\\
\hline
DHT\_BIGN &  Транспорт ключа согласно СТБ~34.101.45\\
\hline
DHE\_PSK\_BIGN &  На основе предварительно распределенных общих 
секретов и протокола Диффи~-- Хеллмана с эфемерными ключами\\
\hline
DHT\_PSK\_BIGN &  На основе предварительно распределенных общих 
секретов ключей и транспорта ключа согласно СТБ~34.101.45\\
\hline
\end{tabular}
\end{table}
В алгоритмах DHT\_BIGN, DHE\_BIGN, DHT\_PSK\_BIGN сервер пересылает клиенту 
свой сертификат. Формат сертификата ДОЛЖЕН соответствовать СТБ~34.101.19 
с уточнениями, заданными в СТБ~34.101.45 (приложение Д). Сертификат ДОЛЖЕН 
иметь расширение KeyUsage. 

\subsubsection{Алгоритм DHE\_BIGN}\label{BSUITES.2.3.1}

Алгоритм DHE\_BIGN состоит в выполнении протокола Диффи~-- Хеллмана с 
эфемерными ключами. В протоколе используются эллиптические кривые, 
определенные в СТБ~34.101.45 (пункт~5.3). Для генерации пар эфемерных ключей 
используются алгоритмы, определенные в СТБ~34.101.45 (пункт~6.2). При 
выполнении DHE\_BIGN сервер подписывает свой эфемерный ключ и 
дополнительные данные. Для выработки и проверки ЭЦП используются 
алгоритмы, определенные в СТБ~34.101.45 (пункт~7.1). 

Для применения DHE\_BIGN сервер ДОЛЖЕН переслать клиенту свой сертификат в 
сообщении \lstinline{Certificate}. Сертификат ДОЛЖЕН содержать открытый ключ 
алгоритмов ЭЦП. В расширении \lstinline{KeyUsage} сертификата ДОЛЖЕН быть 
установлен бит~\lstinline{digitalSignature}. 

Сервер использует параметры эллиптической кривой из своего сертификата, 
генерирует эфемерные личный ключ \lstinline{dS} и открытый ключ 
\lstinline{QS} с помощью алгоритма, определенного в СТБ~34.101.45 
(пункт~6.2.2). Затем сервер подписывает структуру, составленную из 
\lstinline{QS} и случайных данных \lstinline{client_random}, 
\lstinline{server_random}. При выработке ЭЦП используется личный ключ,  
которому соответствует открытый ключ сертификата сервера. Сервер передает 
\lstinline{QS} и выработанную подпись клиенту в сообщении 
\lstinline{ServerKeyExchange}.   

Клиент проверяет полученные сертификат и ЭЦП. Если при проверке произошла 
ошибка, то клиент ДОЛЖЕН прекратить протокол Handshake. В противном случае 
клиент использует параметры эллиптической кривой из сертификата сервера, 
генерирует эфемерные личный ключ \lstinline{dC} и открытый ключ 
\lstinline{QC} с помощью алгоритма, определенного в СТБ~34.101.45 
(пункт~6.2.2). Клиент передает открытый ключ серверу в сообщении 
\lstinline{ClientKeyExchange}.  

Сервер проверяет \lstinline{QC} с помощью алгоритма, определенного в СТБ~34.101.45 
(пункт~6.2.3). Если при проверке произошла ошибка, то сервер ДОЛЖЕН прекратить 
протокол Handshake. 

Открытые ключи \lstinline{QS}, \lstinline{QC} являются точками 
эллиптической кривой, заданной в сертификате сервера. Сервер находит 
\lstinline{dS}-кратное точки \lstinline{QC}, а клиент находит 
\lstinline{dC}-кратное точки \lstinline{QS}. Вычисление кратной точки 
описано в СТБ~34.101.45 (пункт~4.2.4). Если все шаги протокола выполнены 
корректно и злоумышленник не вмешивался в обмен сообщениями, то в 
результате вычислений стороны получат одну и ту же секретную точку \lstinline{Q}.  

Точка \lstinline{Q} представляется строкой байтов (октетов) по правилам, 
описанным в СТБ~34.101.45 (пункт~5.4). Полученная строка выступает в роли 
\lstinline{pre_master_secret}. По \lstinline{pre_master_secret} строится 
\lstinline{master_secret} (см.~\ref{HANDSHAKE.16}). 

\subsubsection{Алгоритм DHT\_BIGN}\label{BSUITES.2.3.2}

Алгоритм DHT\_BIGN состоит в выполнении сторонами алгоритмов транспорта 
ключа, определенных в  СТБ~34.101.45 (пункт~7.2). К алгоритмам транспорта 
относится алгоритм создания токена транспортируемого ключа и алгоритм 
разбора токена. При создании и разборе токена ДОЛЖЕН использоваться 
нулевой заголовок ключа [см. СТБ~34.101.45 (пункт~5.6)]. 

Для применения DHT\_BIGN сервер ДОЛЖЕН переслать клиенту свой сертификат в 
сообщении \lstinline{Certificate}. Сертификат ДОЛЖЕН содержать открытый ключ 
алгоритмов транспорта ключа. В расширении KeyUsage сертификата ДОЛЖЕН быть 
установлен бит \lstinline{keyEncipherment}. 

Клиент проверяет полученный сертификат и определяет размещенные в 
сертификате параметры эллиптической кривой и открытый ключ. Клиент 
генерирует случайный ключ \lstinline{pre_master_secret} из 48 байтов, 
создает токен этого ключа, используя открытый ключ сертификата, и 
пересылает токен в сообщении \lstinline{ClientKeyExchange}.  

Сервер разбирает токен, используя свой личный ключ. Если при разборе 
произошла ошибка, то сервер ДОЛЖЕН прекратить протокол Handshake. В 
противном случае сервер использует полученный по токену 
\lstinline{pre_master_secret} для построения \lstinline{master_secret} 
(см.~\ref{HANDSHAKE.16}).  

\subsubsection{Алгоритм DHE\_PSK\_BIGN}\label{BSUITES.2.3.3}

Алгоритм DHE\_PSK\_BIGN состоит в построении \lstinline{pre_master_secret} по 
предварительно распределенному между клиентом и сервером секрету. Для 
того, чтобы \lstinline{pre_master_secret} не повторялся и чтобы у злоумышленника не 
было возможности определить предварительно распределенный секрет по 
сообщениям протокола Handshake, при формировании 
\lstinline{pre_master_secret} используется дополнительный ключ, который 
формируется по протоколу Диффи~-- Хеллмана.  

Для применения DHE\_PSK\_BIGN сервер выбирает параметры эллиптической 
кривой, группа точек которой будет использоваться в протоколе Диффи~-- 
Хеллмана. Сервер ДОЛЖЕН использовать стандартные параметры, заданные в 
СТБ~34.101.45 (приложение Б). Для ссылки на параметры должны использоваться  
идентификаторы, определенные в СТБ~34.101.45 (приложение Д). Идентифакторы 
должны кодироваться по правилам, заданным в ГОСТ 34.973 и кратко описанным 
в СТБ~34.101.45 (приложение А). 

После выбора параметров сервер генерирует эфемерные личный ключ \lstinline{dS} и 
открытый ключ \lstinline{QS} с помощью алгоритма, определенного в СТБ~34.101.45 
(пункт~6.2.2). Сервер передает описание параметров и открытый ключ 
\lstinline{QS} клиенту в сообщении \lstinline{ServerKeyExchange}. 
Дополнительно в \lstinline{ServerKeyExchange} сервер МОЖЕТ переслать 
клиенту подсказку по выбору общего секрета (см.~\ref{CRYPTO.2.4}).   

Клиент определяет параметры эллиптической кривой по полученному 
идентификатору и проверяет открытый ключ \lstinline{QS} с помощью алгоритма, 
определенного в СТБ~34.101.45 (пункт~6.2.3). Если при определении параметров 
или при проверке открытого ключа произошла ошибка, то клиент ДОЛЖЕН 
прекратить Handshake. В противном случае клиент выбирает общий секрет, 
используя подсказку сервера. Если подсказки нет, то клиент выбирает общий 
секрет самостоятельно. Клиент высылает серверу идентификатор выбранного 
секрета  в \lstinline{ClientKeyExchange}. Кроме этого, клиент генерирует 
эфемерные личный ключ \lstinline{dC} и открытый ключ \lstinline{QC} 
с помощью алгоритма, определенного в СТБ~34.101.45 (пункт~6.2.2). 
Открытый ключ \lstinline{QC} также пересылается в 
\lstinline{ClientKeyExchange}.  

По идентификатору секрета сервер определяет сам секрет, который 
обозначается \lstinline{psk} и представляет собой строку байтов. Если сервер не может 
определить секрет по полученному идентификатору, то он МОЖЕТ ответить 
сообщением об ошибке \lstinline{unknown_psk_identity} (см.~\ref{ALERT.3}). В качестве 
альтернативы, если сервер хочет скрыть факт незнания секрета, то он МОЖЕТ 
продолжить протокол, как если бы он знал секрет, но секрет оказался 
неверным. При этом сервер в конце концов отвечает сообщением об ошибке 
\lstinline{decrypt_error}. 

Сервер проверяет открытый ключ \lstinline{QC} с помощью алгоритма, определенного в СТБ~
34.101.45 (пункт~6.2.3). Если при проверке открытого ключа произошла ошибка, 
то сервер ДОЛЖЕН прекратить Handshake. 

Сервер находит \lstinline{dS}-кратное точки \lstinline{QC}, а клиент 
находит \lstinline{dC}-кратное точки \lstinline{QS}.  
Вычисление кратной точки описано в СТБ~34.101.45 (пункт~4.2.4). Если все 
шаги протокола выполнены корректно и злоумышленник не вмешивался в обмен 
сообщениями, то в результате вычислений стороны получат одну и ту же 
секретную точку \lstinline{Q}.  

Точка \lstinline{Q} представляется строкой байтов (октетов) по правилам, описанным в 
СТБ~34.101.45 (пункт~5.4). Полученная строка состоит из 64, 96 или 128 байтов 
и обозначается \lstinline{other_secret}. 

Ключ \lstinline{pre_master_secret} является результатом конкатенации:
\begin{lstlisting}
len(other_secret) + other_secret + len(psk) + psk,
\end{lstlisting}
где \lstinline{len(other_secret)}, \lstinline{len(psk)}~--- длины 
\lstinline{other_secret} и \lstinline{psk}, представленные двумя байтами. 

По \lstinline{pre_master_secret} строится \lstinline{master_secret} 
(см.~\ref{HANDSHAKE.16}). 

Реализации ДОЛЖНЫ поддерживать идентификаторы секретов, состоящие из 128 
байтов, и секреты, состоящие из 64 байтов. Поддержка идентификаторов и 
секретов больших длин НЕ РЕКОМЕНДУЕТСЯ. 

\subsubsection{Алгоритм DHT\_PSK\_BIGN}\label{BSUITES.2.3.4}

Алгоритм DHT\_PSK\_BIGN состоит в построении \lstinline{pre_master_secret} по 
предварительно распределенному между клиентом и сервером секрету. Для 
того, чтобы \lstinline{pre_master_secret} не повторялся и чтобы у злоумышленника не 
было возможности определить предварительно распределенный секрет по 
сообщениям протокола Handshake, при формировании 
\lstinline{pre_master_secret} используется дополнительный ключ. Ключ 
передается серверу с помощью алгоритмов транспорта, определенных в 
СТБ~34.101.45 (пункт~7.2). К алгоритмам транспорта относится алгоритм 
создания  токена транспортируемого ключа и алгоритм разбора токена. При 
создании и разборе токена ДОЛЖЕН использоваться нулевой заголовок ключа 
(см. СТБ~34.101.45 (пункт~5.6)).  

Для применения DHT\_PSK\_BIGN сервер ДОЛЖЕН переслать клиенту свой 
сертификат в сообщении \lstinline{Certificate}. Сертификат ДОЛЖЕН содержать открытый 
ключ алгоритмов транспорта ключа. В расширении \lstinline{KeyUsage} сертификата ДОЛЖЕН 
быть установлен бит \lstinline{keyEnchipherment}. 

Дополнительно в \lstinline{ServerKeyExchange} сервер МОЖЕТ переслать клиенту подсказку 
по выбору общего секрета (см.~\ref{CRYPTO.2.4}). Если подсказка не используется, то 
\lstinline{ServerKeyExchange} может не передаваться. Используя подсказку, клиент 
выбирает общий секрет. Если подсказки нет, то клиент выбирает общий секрет 
самостоятельно. Клиент высылает серверу идентификатор выбранного секрета  
в \lstinline{ClientKeyExchange}. 

Кроме этого, клиент проверяет сертификат сервера и определяет размещенные 
в сертификате параметры эллиптической кривой и открытый ключ. Клиент 
генерирует случайный ключ \lstinline{other_secret} из 48 байтов. Клиент 
создает токен этого ключа, используя открытый ключ сертификата, и 
пересылает токен в сообщении \lstinline{ClientKeyExchange}.  

По идентификатору секрета стороны определяют секрет \lstinline{psk}. Если сервер не 
может определить секрет по полученному идентификатору, то он МОЖЕТ 
ответить сообщением об ошибке \lstinline{unknown_psk_identity} 
(см.~\ref{ALERT.3}). В качестве альтернативы, если сервер хочет скрыть 
факт незнания секрета, то он МОЖЕТ продолжить протокол, как если бы он 
знал секрет, но секрет оказался неверным. При этом сервер в конце концов 
отвечает сообщением об ошибке \lstinline{decrypt_error}. 

Сервер разбирает токен клиента, используя свой личный ключ. Если при 
разборе произошла ошибка, то сервер ДОЛЖЕН прекратить протокол Handshake. 
В противном случае сервер определяет переданный клиентом ключ 
\lstinline{other_secret}. 

Ключ \lstinline{pre_master_secret} является результатом конкатенации:
\begin{lstlisting}
len(other_secret) + other_secret + len(psk) + psk,
\end{lstlisting}
где \lstinline{len(other_secret)}, \lstinline{len(psk)}~--- длины 
\lstinline{other_secret} и \lstinline{psk}, представленные двумя байтами. 

По \lstinline{pre_master_secret} строится \lstinline{master_secret} 
(см.~\ref{HANDSHAKE.16}). 

Реализации ДОЛЖНЫ поддерживать идентификаторы секретов, состоящие из 128 
байтов, и секреты, состоящие из 64 байтов. Поддержка идентификаторов и 
секретов больших длин НЕ РЕКОМЕНДУЕТСЯ. 

\hiddensection{Методы аутентификации}\label{BSUITES.3}

\subsection{Аутентификация сервера}\label{BSUITES.3.1}

При использовании алгоритмов DHE\_BIGN, DHT\_BIGN, DHT\_PSK\_BIGN сервер 
пересылает клиенту свой сертификат. Последующее успешное завершение 
протокола Handshake означает, что проведена аутентификация сервера: 
сертификат сервера действителен и сервер знает личный ключ, 
соответствующий открытому ключу сертификата. 

При использовании алгоритмов DHE\_PSK\_BIGN и DHT\_PSK\_BIGN клиент и
сервер договариваются об использовании предварительного распределенного
секрета \lstinline{psk}. Если \lstinline{psk} был распределен по защищенным
каналам и был распределен только этим сторонам, то успешное завершение
Handshake означает, что сервер знает \lstinline{psk}, т.~е.
является подлинным.

\subsection{Аутентификация клиента}\label{BSUITES.3.2}

Для аутентификации клиента могут использоваться методы
\mbox{\lstinline{bign128_auth},} \lstinline{bign192_auth} и
\lstinline{bign256_auth}, которые включаются в 
перечисление~\lstinline{ClientCertificateType}: 
\begin{lstlisting}
ClientCertificateType += {bign128_auth(231),
    bign192_auth(232), bign256_auth(233)};
\end{lstlisting}

Для применения данных методов сервер в сообщении~\lstinline{CertificateRequest} 
ДОЛЖЕН запросить у клиента его сертификат. После получения сообщения 
\lstinline{CertificateRequest} клиент ДОЛЖЕН отправить запрашиваемый сертификат 
в сообщении~\lstinline{Certificate}.  

В СТБ~34.101.45 (пункт~5.2) для алгоритмов ЭЦП определены три уровня 
стойкости: $l = 128$, $l = 192$ и $l = 256$. При использовании методов 
\lstinline{bign128_auth}, \lstinline{bign192_auth} и 
\lstinline{bign256_auth} сертификат ДОЛЖЕН содержать открытый ключ, 
который можно использовать на уровнях стойкости $l \geq 128$,  
$l\geq 192$ и $l = 256$ соответственно.  

Формат сертификата ДОЛЖЕН соответствовать СТБ~34.101.19 с уточнениями, 
заданными в СТБ~34.101.45 (приложение Д). Сертификат ДОЛЖЕН иметь 
расширение \lstinline{KeyUsage} и в этом расширении ДОЛЖЕН быть установлен бит 
\lstinline{digitalSignature}. 

Успешное завершение протокола Handshake означает, что проведена 
аутентификация клиента: сертификат клиента действителен и клиент знает 
личный ключ, соответствующий открытому ключу сертификата. 

Методы аутентификации не применяются и предыдущие ограничения не 
действуют, если клиент передает в сообщении \lstinline{Certificate} пустую цепочку 
сертификатов. В этом случае сервер может либо прервать Handshake, либо 
продолжить его, но уже без аутентификации клиента (см.~\ref{HANDSHAKE.12}). 

При использовании алгоритмов DHE\_PSK\_BIGN, DHT\_PSK\_BIGN проводится неявная 
аутентификация клиента. При соблюдении мер защиты общего секрета \lstinline{psk} 
успешное завершение Handshake означает, что клиент знает \lstinline{psk}, 
т.~е. является подлинным. 

\subsection{Алгоритмы хэширования и ЭЦП}\label{BSUITES.3.3}

В методах аутентификации используется алгоритм хэширования, определенный в 
СТБ~34.101.31 (пункт~6.9). Этот алгоритм добавляется в перечисление 
\lstinline{HashAlgorithm} под именем~\lstinline{belt_hash}:
\begin{lstlisting}
HashAlgorithm += {belt_hash(231)};
\end{lstlisting}
 
В методах аутентификации используются также алгоритмы ЭЦП, определенные в 
СТБ~34.101.45 (пункт~7.1). Эти алгоритмы добавляются в перечисление 
\lstinline{SignatureAlgorithm} под именем~\lstinline{bign_sign}: 
\begin{lstlisting}
SignatureAlgorithm += {bign_sign(231)};
\end{lstlisting}

Допустимая пара <<алгоритм хэширования, алгоритмы ЭЦП>> описывается значением 
\lstinline|{belt_hash, bign_sign}| типа \lstinline{SignatureAndHashAlgorithm}. 

В алгоритмах \lstinline{bign_sign} на уровне стойкости $l$ должна
использоваться функция хэширования с $2l$-битовыми значениями. Поскольку
длина хэш-значения \lstinline{belt_hash} составляет 256 битов, алгоритмы
\lstinline{bign_sign} могут выполняться только на уровне $l = 128$. Тем не
менее, в будущем список разрешенных функций хэширования может пополняться,
и при этом могут быть поддержаны остальные уровни стойкости
\lstinline{bign_sign}. Сказанное означает, что значение
\lstinline|{belt_hash, bign_sign}| соответствует методу аутентификации
\lstinline{bign128_auth}, и не соответствует методам
\lstinline{bign192_auth}, \lstinline{bign256_auth}.

\hiddensection{Сообщения и шаги}\label{BSUITES.4}

\subsection{Уточнения}\label{BSUITES.4.1}

В настоящем подразделе уточняются сообщения и шаги протокола
Handshake. Уточнения касаются деталей использования
определенных выше криптонаборов и методов аутентификации при выполнении
протокола.

Сообщения и шаги протоколов Record, 
Change~Cipher~Spec и Alert не уточняются, в этом 
нет необходимости. 

\subsection{Приветственные сообщения}\label{BSUITES.4.2}

Для использования криптонаборов настоящего приложения стороны указывают их
идентификаторы (см.~\ref{BSUITES.1}) в поле \lstinline{cipher_suites}
сообщения \lstinline{ClientHello} и в поле \lstinline{cipher_suite}
сообщения \lstinline{ServerHello}.

Для криптонаборов, определенных в настоящем приложении, сообщение
\lstinline{ClientHello} ДОЛЖНО содержать расширение
\lstinline{signature_algorithms} (см.~\ref{HANDSHAKE.7}) за исключением
случая, когда клиент поддерживает только одну пару
\lstinline|{belt_hash,bign_sign}|. Клиент МОЖЕТ опустить передачу этой пары
в расширении. При получении ClientHello с отсутствующим расширением
\lstinline{signature_algorithms} сервер ДОЛЖЕН считать, что клиент
поддерживает только пару \lstinline|{belt_hash,bign_sign}|.

Сообщение \lstinline{HelloRequest} не уточняется.

\subsection{Сообщение сервера \lstinline{Certificate}}\label{BSUITES.4.3}

Сообщение сервера \lstinline{Certificate} высылается при использовании любого из 
алгоритмов DHT\_BIGN, DHE\_BIGN, DHT\_PSK\_BSUITES. Содержание сообщения было 
определено при описании алгоритмов. 

\subsection{Сообщение \lstinline{ServerKeyExchange}}\label{BSUITES.4.4}

Сообщение \lstinline{ServerKeyExchange} обязательно высылается при использовании 
алгоритмов DHE\_BIGN, DHE\_PSK\_BIGN может высылаться при использовании 
алгоритма DHT\_PSK\_BIGN и не высылается при использовании алгоритма 
DHT\_BSUITES. Содержание сообщения было определено при описании алгоритмов. 

Формат сообщения \lstinline{ServerKeyExchange} определяется следующим образом:
\begin{lstlisting}
struct {
  select (KeyExchangeAlgorithm) {
  case dhe_bign:
    opaque public<64..128>;
    digitally-signed struct {
      opaque client_random[32];
      opaque server_random[32];
      opaque public<64..128>;
    } signed_params;
    case dhe_psk_bign:
      opaque psk_identity_hint<0..2^16-1>;
      opaque oid<3..255>;
      opaque public<64..128>;
    case dht_psk_bign:
      opaque psk_identity_hint<0..2^16-1>;
  };
} ServerKeyExchange;
\end{lstlisting}

Поля структуры \lstinline{ServerKeyExchange} имеют следующее значение:
\begin{itemize}
\item [--]
\lstinline{client_random}~--- случайные данные клиента (см.~\ref{RECORD.2});

\item [--]
\lstinline{server_random}~--- случайные данные сервера (см.~\ref{RECORD.2});

\item [--]
\lstinline{public}~--- эфемерный открытый ключ сервера. Открытый ключ 
представляется строкой байтов (октетов) по правилам, описанным в СТБ~
34.101.45 (пункт~5.4). В зависимости от уровня стойкости строка состоит из 
64, 96 или 128 байтов; 

\item [--]
\lstinline{signed_params}~--- ЭЦП полей \lstinline{client_random}, 
\lstinline{server_random}, \lstinline{public}; 

\item [--]
\lstinline{psk_identity_hint}~--- подсказка по выбору общего 
предварительно распределенного секрета; 

\item [--]
\lstinline{oid}~--- кодированное представление идентификатора параметров 
эллиптической кривой. 
\end{itemize}

Используемое в структуре \lstinline{ServerKeyExchange} перечисление 
\lstinline{KeyExchangeAlgorithm} определяется следующим образом: 
\begin{lstlisting}
enum {dhe_bign, dhe_psk_bign, dht_psk_bign} KeyExchangeAlgorithm;
\end{lstlisting}

Для данного перечисления элементы означают следующее:
\begin{itemize}
\item[--]
\lstinline{dhe_bign}~--- используется алгоритм DHE\_BIGN;

\item[--]
\lstinline{dhe_psk_bign}~--- используется алгоритм DHE\_PSK\_BIGN;

\item[--]
\lstinline{dht_psk_bign}~--- используется алгоритм DHT\_PSK\_BSUITES.
\end{itemize}

\subsection{Сообщение \lstinline{CertificateRequest}}\label{BSUITES.4.5} 

Сервер может отправить сообщение \lstinline{CertificateRequest} для аутентификации 
клиента. В этом случае поля структуры \lstinline{CertificateRequest} должны быть 
заданы следующим образом:  

\begin{itemize}
\item[--]
\lstinline{certificate_types}~--- идентификаторы методов аутентификации 
\lstinline{bign128_auth}, \lstinline{bign192_auth} или 
\lstinline{bign256_auth}; 

\item[--]
\lstinline{supported_signature_algorithms}~--- определенные 
в~\ref{BSUITES.3.3} пары идентификаторов <<алгоритм хэширования, алгоритмы
ЭЦП>>.
\end{itemize}

Поле \lstinline{certificate_authorities} определяется в соответствии 
с~\ref{HANDSHAKE.10}. 

\subsection{Сообщение \lstinline{ServerHelloDone}}\label{BSUITES.4.6}

Сообщение \lstinline{ServerHelloDone} не уточняется. 

\subsection{Сообщение клиента \lstinline{Certificate}}\label{BSUITES.4.7}

Сообщение посылается клиентом, если сервер прислал запрос 
\lstinline{CertificateRequest}. В этом сообщении клиент высылает серверу свой 
сертификат, соответствующий одному из запрошенных методов аутентификации: 
\lstinline{bign128_auth}, \lstinline{bign192_auth} или 
\mbox{\lstinline{bign256_auth}.} Если клиент не имеет подходящего 
сертификата, то он может послать в сообщении \lstinline{Certificate} 
пустую цепочку сертификатов. В этом случае сервер принимает решение о  
возможности продолжения протокола Handshake без аутентификации клиента. 

\subsection{Сообщение \lstinline{ClientKeyExchange}}\label{BSUITES.4.8}

Сообщение \lstinline{ClientKeyExchange} обязательно высылается при 
использовании любого из алгоритмов DHE\_BIGN, DHT\_BIGN, DHE\_PSK\_BIGN и 
DHT\_PSK\_BSUITES. Содержание сообщения было определено при описании 
алгоритмов.  

Формат сообщения \lstinline{ClientKeyExchange} определяется следующим образом:
\begin{lstlisting}
struct {
  select (KeyExchangeAlgorithm) {
  case dht_bign:
    opaque token<96..160>;
  case dhe_bign:
    opaque public<64..128>;
  case dhe_psk_bign:
    opaque psk_identity<0..2^16-1>;
    opaque public<64..128>;
  case dht_psk_bign:
    opaque psk_identity<0..2^16-1>;
	opaque token<96..160>;
  };
} ClientKeyExchange;
\end{lstlisting}

Поля структуры \lstinline{ClientKeyExchange} имеют следующее значение:
\begin{itemize}
\item [--]
\lstinline{token}~--- токен ключа \lstinline{pre_master_secret}. 
В зависимости от уровня стойкости токен состоит из~96, 128 или 160 байтов; 

\item[--]
\lstinline{public}~--- эфемерный открытый ключ клиента. Открытый 
ключ представляется строкой октетов по правилам, определенным в СТБ~34.101.45 
(пункт~5.4). В зависимости от уровня стойкости строка состоит из~64, 96 
или 128 байтов;  

\item[--]
\lstinline{psk_identity}~--- идентификатор общего предварительно 
распределенного секрета. 
\end{itemize}

Используемое в структуре \lstinline{ClientKeyExchange} перечисление 
\lstinline{KeyExchangeAlgorithm} определено в~\ref{BSUITES.4.4} и доопределяется 
следующим образом: 
\begin{lstlisting}
KeyExchangeAlgorithm += {dht_bign};
\end{lstlisting}

Дополнительный элемент перечисления означает следующее:
\begin{itemize}
\item[--]
\lstinline{dht_bign}~--- используется алгоритм DHT\_BSUITES.
\end{itemize}

\subsection{Сообщения \lstinline{CertificateVerify, Finished}}\label{BSUITES.4.9}

Для выработки ЭЦП при формировании сообщения \lstinline{CertificateVerify} 
используются алгоритмы ЭЦП, определенные в~\ref{BSUITES.3.3}.  

При формировании сообщения \lstinline{Finished} ДОЛЖЕН использоваться алгоритм 
генерации псевдослучайных чисел, определенный в~\ref{BSUITES.2.2}. Для хэширования 
сообщений протокола Handshake ДОЛЖЕН использоваться алгоритм, 
определенный в СТБ~34.101.31 (пункт~6.9). Параметр 
\lstinline{verify_data_length} ДОЛЖЕН быть равен 12. 

\end{appendix}
\mbox{}
\vfill
\mbox{}
\clearpage
