\chapter{Протокол Alert}\label{ALERT}

\section{Сигнальные сообщения}\label{ALERT.1}

Протокол Record поддерживает передачу сигнальных сообщений. 
Эти сообщения формируются протоколом Alert и передают уровень 
сигнала (предупреждение или критическая ошибка) и его описание. 
Сигнальные сообщения, соответствующие критическим ошибкам, приводят к 
немедленному прерыванию соединения. В этом случае другие соединения 
данного сеанса могут продолжаться, но идентификатор сеанса ДОЛЖЕН быть 
признан недействительным, чтобы предотвратить использование сеанса, в 
котором возникла ошибка, для возобновления или переустановки связи. 
Как и другие сообщения, сигнальные сообщения защищаются и сжимаются в 
соответствии с текущим состоянием соединения. 

Сообщения протокола~Alert описываются следующим образом:
\begin{lstlisting}
struct {
  AlertLevel level;
  AlertDescription description;
} Alert;
\end{lstlisting}

Поля структуры \lstinline{Alert} имеют следующее значение:
\begin{itemize}
\item[--]
\lstinline{level}~--- уровень сигнального сообщения (предупреждение или 
критическая ошибка); 

\item[--]
\lstinline{description}~--- описание сигнального сообщения.
\end{itemize}

Типы вложенных в \lstinline{Alert} полей определяются следующим образом:
\begin{lstlisting}
enum {warning(1), fatal(2), (255)} AlertLevel;
enum {
  close_notify(0),
  unexpected_message(10),
  bad_record_mac(20),
  record_overflow(22),
  decompression_failure(30),
  handshake_failure(40),
  bad_certificate(42),
  unsupported_certificate(43),
  certificate_revoked(44),
  certificate_expired(45),
  certificate_unknown(46),
  illegal_parameter(47),
  unknown_ca(48),
  access_denied(49),
  decode_error(50),
  decrypt_error(51),
  protocol_version(70),
  insufficient_security(71),
  internal_error(80),
  user_canceled(90),
  no_renegotiation(100),
  unsupported_extension(110),
  unknown_psk_identity(115)
  (255)
} AlertDescription;
\end{lstlisting}

Элемент \lstinline{warning} перечисления \lstinline{AlertLevel} 
соответствует предупредительному сигнальному сообщению, элемент 
\lstinline{fatal}~--- критическому. Элементы перечисления 
\lstinline{AlertDescription} описываются в~\ref{ALERT.2} и~\ref{ALERT.3}.  
 
\section{Сообщения о закрытии соединения}\label{ALERT.2}

Обе стороны, клиент и сервер, должны знать, что соединение закрывается, 
чтобы избежать ситуации, в которой одна сторона считает, что соединение 
закрыто, а вторая сторона считает наоборот.  

Каждая из сторон может инициировать закрытие соединения, отправив 
предупредительное сигнальное сообщение \lstinline{close_notify}. Это сообщение 
извещает получателя о том, что отправитель больше не будет посылать 
сообщения в данном соединении. Любые данные, полученные после этого 
сигнального сообщения, игнорируются. 

При получении сообщения о закрытии соединения получатель ДОЛЖЕН ответить 
своим сигнальным сообщением \lstinline{close_notify} и немедленно закрыть соединение, 
отбросив любые задержанные сообщения. От инициатора закрытия соединения 
не требуется ожидать ответное сообщение \lstinline{close_notify}, он может сразу 
прекратить прием данных. При закрытии соединения передача сообщения 
\lstinline{close_notify} является обязательной для каждой из сторон, если они до этого 
не получали критических сигнальных сообщений.  

Если прикладной протокол предусматривает передачу данных после закрытия 
соединения TLS, то реализация TLS должна дождаться ответного сообщения 
\lstinline{close_notify} и проинформировать прикладной протокол о том, что соединение 
закрыто. Если же передача данных после завершения соединения не 
предусмотрена, то реализация TLS МОЖЕТ закрыть соединение, не дожидаясь 
\lstinline{close_notify}. В настоящем стандарте не определяются правила использования 
соединений TLS прикладными протоколами, в том числе правила открытия и 
закрытия соединений. 

\section{Сообщения об ошибках}\label{ALERT.3}

Сторона, обнаружившая ошибку во время выполнения TLS, должна отправить 
другой стороне соответствующее сигнальное сообщение. При передаче или 
получении критического сигнального сообщения, обе стороны должны 
немедленно закрыть соединение. Стороны НЕ ДОЛЖНЫ использовать 
идентификаторы сеанса и ключи, связанные с соединением, закрытым из-за 
ошибки. Таким образом, возобновлять связь после критических ошибок 
НЕЛЬЗЯ. 

Всякий раз, когда при выполнении TLS возникает критическая ошибка, 
противоположной стороне до закрытия соединения ДОЛЖНО быть отправлено 
соответствующее сигнальное сообщение. Для ошибки, уровень соответствующего 
сигнального сообщения которой явно не определен, отправитель МОЖЕТ, по 
своему усмотрению, считать сигнальное сообщение критическим или 
предупредительным. Однако, если отправитель намеревается закрыть 
соединение сразу после передачи сигнального сообщения, то он ДОЛЖЕН 
выбрать критический уровень.  

Если стороны отправляют или принимают предупредительное сигнальное 
сообщение, то соединение может продолжаться. Если принимающая сторона 
решает не продолжать соединение (например, после получения сигнального 
сообщения \lstinline{no_renegotiation}), то ей СЛЕДУЕТ отправить другой стороне 
критическое сигнальное сообщение, чтобы прервать соединение. Отправляющая 
сторона может не знать, как принимающая сторона будет реагировать на 
предупредительное сигнальное сообщение. Поэтому, если у одной из сторон 
возникает ошибка, которая трактуется как предупреждение, и эта сторона 
желает продолжить соединение, то соответствующее сигнальное сообщение 
может не высылаться. Например, если одна из сторон решает принять 
недействительный сертификат другой стороны (возможно, после подтверждения 
принятия конечным пользователем) и продолжить соединение, то ей не следует 
посылать сигнальное сообщение \lstinline{certificate_expired}. 

Определены следующие сигнальные сообщения:
\begin{itemize}
\item[--]
\lstinline{unexpected_message}~--- получено некорректное сообщение. 
Cообщение всегда является критическим. Оно никогда не будет выслано при 
взаимодействии корректных реализаций TLS; 

\item[--]
\lstinline{bad_record_mac}~--- получен фрагмент с некорректным 
значением имитовставки. Данное сообщение означает также, что фрагмент 
расшифрован неверно (длина зашифрованных данных не кратна длине блока 
алгоритма шифрования или дополнение при проверке оказалось некорректным). 
Сообщение всегда является критическим. Оно никогда не будет выслано при 
взаимодействии корректных реализаций TLS (при условии, что в канале связи 
нет помех); 

\item[--]
\lstinline{record_overflow}~--- получен фрагмент 
\lstinline{TLSCiphertext.fragment}, длина которого превышает $2^{14} + 2048$ 
байтов, или после расшифрования которого длина 
\lstinline{TLSCompressed.fragment} превышает $2^{14} + 1024$~байтов. 
Сообщение всегда является критическим. Оно никогда не будет выслано при 
взаимодействии корректных реализаций TLS (при условии, что в канале связи 
нет помех);  

\item[--]
\lstinline{decompression_failure}~--- алгоритм восстановления сжатых 
данных получил некорректные входные данные (например, при восстановлении 
получены данные, объем которых превышает допустимое значение). Сообщение 
всегда является критическим. Оно никогда не будет выслано при 
взаимодействии корректных реализаций TLS (при условии, что в канале связи 
нет помех); 

\item[--]
\lstinline{handshake_failure}~--- отправитель не смог согласовать 
приемлемый набор параметров связи. Сообщение всегда является критическим; 

\item[--]
\lstinline{bad_certificate}~--- сертификат поврежден, содержит 
некорректную ЭЦП и т. д.; 

\item[--]
\lstinline{unsupported_certificate}~--- тип сертификата не 
поддерживается; 

\item[--]
\lstinline{certificate_revoked}~--- сертификат отозван выпустившей 
его стороной; 

\item[--]
\lstinline{certificate_expired}~--- срок действия сертификата истек 
или еще не наступил; 

\item[--]
\lstinline{certificate_unknown}~--- при обработке сертификата 
возникла ошибка, не определенная выше, которая не позволяет использовать 
сертификат; 

\item[--]
\lstinline{illegal_parameter}~--- в сообщении протокола Handshake 
значение некоторого поля лежит вне допустимого диапазона или не 
согласуется со значениями других полей. Сообщение всегда является 
критическим; 

\item[--]
\lstinline{unknown_ca}~--- получена достоверная цепочка сертификатов 
или ее часть, но сертификат не был признан действительным, поскольку 
сертификат соответствующего удостоверяющего центра не был найден или не 
соответствует имеющемуся сертификату надежного удостоверяющего центра. 
Сообщение всегда является критическим; 

\item[--]
\lstinline{access_denied}~--- был получен действительный сертификат, 
но при проверке прав доступа отправитель решил не продолжать согласование. 
Сообщение всегда является критическим; 

\item[--]
\lstinline{decode_error}~--- сообщение не может быть декодировано, 
так как значение одного из полей лежит вне допустимого диапазона или длина 
сообщения некорректна. Сообщение всегда является критическим. Оно никогда 
не будет выслано при взаимодействии корректных реализаций TLS (при 
условии, что в канале связи нет помех); 

\item[--]
\lstinline{decrypt_error}~--- неудачное завершение некоторой 
криптографической операции во время выполнения Handshake, в том числе 
некорректное завершение алгоритма проверки ЭЦП или ошибка при проверке 
правильности сообщения \lstinline{Finished}. Сообщение всегда является критическим; 

\item[--]
\lstinline{protocol_version}~--- номер версии протокола, предложенный 
клиентом для согласования, не поддерживается. Сообщение всегда является 
критическим; 

\item[--]
\lstinline{insufficient_security}~--- это сообщение используется вместо 
\lstinline{handshake_failure} в тех случаях, когда процесс согласования  
параметров связи завершился неудачно по причине того, что сервер 
потребовал использования более надежных параметров, чем те, которые 
поддерживает клиент. Сообщение всегда является критическим; 

\item[--] 
\lstinline{internal_error}~--- внутренняя ошибка, которая не 
связана  с противоположной стороной или логикой протокола (например, ошибка 
выделения памяти), которая делает невозможным дальнейшее выполнение 
протокола. Сообщение всегда является критическим; 

\item[--]
\lstinline{user_canceled}~--- выполнение протокола Handshake 
остановлено по причине, не связанной с логикой протокола. Если 
пользователь останавливает выполнение после того, как протокол завершен, 
то рекомендуется закрыть соединение отправкой сигнального сообщения 
\lstinline{close_notify}. Это сообщение должно следовать за сообщением 
\lstinline{user_canceled}. Сообщение \lstinline{user_canceled} обычно 
является предупредительным;  

\item[--]
\lstinline{no_renegotiation}~--- сообщение отсылается клиентом в 
ответ на запрос сервера \lstinline{HelloRequest} или сервером в ответ на запрос 
клиента \lstinline{ClientHello} после установки связи в тех случаях, когда получатель 
запроса не желает переустанавливать связь. После получения сообщения 
запрашивающая сторона может отказаться от переустановки связи. Например, 
этой стороной может быть  сервер, на котором уже запущена программа, 
ожидающая переустановку, эта программа получила параметры защиты, и ход ее 
выполнения не может быть изменен. Сообщение \lstinline{no_renegotiation} всегда 
является предупредительным; 

\item[--] 
\lstinline{unsupported_extension}~--- это сообщение высылает клиент, 
который получает сообщение сервера \lstinline{ServerHello} с расширением, не 
включенным клиентом в соответствующее сообщение \lstinline{ClientHello}. 
Сообщение всегда является критическим; 

\item[--] 
\lstinline{unknown_psk_identity}~--- это сообщение высылает сервер, 
если он не может определить предварительно распределенный секрет по 
полученному идентификатору (см.~\ref{CRYPTO.2.4}). Сообщение всегда 
является критическим. 
\end{itemize}


                                 